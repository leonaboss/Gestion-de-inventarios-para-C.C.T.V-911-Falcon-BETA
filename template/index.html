{% extends 'base.html' %}
{% block title %}Inventario - Bienes{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    {% if error_message %}
        <div class="alert alert-warning mt-3" role="alert">
            ⚠️ {{ error_message }}
        </div>
    {% endif %}

    <div id="mainContent" class="mt-4">
        <h2>Inventario de Bienes</h2>
        <h3 class="mt-2 mb-3">VEN 9-1-1 SEDE FALCON</h3>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <a href="{% url 'agregar_producto' %}" class="btn btn-primary me-2">➕ Agregar bien</a>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Acciones de Datos
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'export_productos_excel' %}">Exportar a Excel</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'importar_productos_excel' %}" method="post" enctype="multipart/form-data" class="p-3">
                                {% csrf_token %}
                                <label for="excel_file_input" class="form-label">Importar Excel:</label>
                                <input type="file" name="excel_file" id="excel_file_input" class="form-control form-control-sm mb-2" accept=".xlsx, .xls" required>
                                <button type="submit" class="btn btn-info btn-sm w-100">
                                    <i class="fas fa-file-import"></i> Importar Excel
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
            <form method="get" action="{% url 'inventario' %}" class="d-flex" style="max-width: 300px;">
                <input class="form-control me-2" type="search" name="q" placeholder="Buscar bien..." value="{{ current_query }}">
                <button class="btn btn-outline-secondary" type="submit">Buscar</button>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover rounded shadow-sm">
                <thead>
                    <tr>
                        {% with 'cantidad' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">Cantidad {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'codigo' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">CODIGO {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'num_de_bien' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">NumDeBien {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'descripcion' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">Descripción {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'cod_bien' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">CodBien {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'concepto' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">Concepto {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'valor_unitario' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">Valor unitario {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        {% with 'fecha_agregado' as field %}<th><a href="?sort={{ field }}&dir={% if current_sort == field and current_dir == 'asc' %}desc{% else %}asc{% endif %}&q={{ current_query }}">Fecha agregado {% if current_sort == field %}{% if current_dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>{% endwith %}
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td>{{ producto.cantidad }}</td>
                        <td class="text-nowrap">{{ producto.codigo }}</td>
                        <td>{{ producto.num_de_bien }}</td>
                        <td>{{ producto.descripcion }}</td>
                        <td>{{ producto.cod_bien }}</td>
                        <td>{{ producto.concepto }}</td>
                        <td>{{ producto.valor_unitario }}</td>
                        <td>{{ producto.fecha_agregado|date:"d/m/Y H:i" }}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <form method="post" action="{% url 'ocultar_producto' producto.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-secondary">Inactivar</button>
                                </form>
                                <a href="{% url 'editar_producto' producto.id %}" class="btn btn-sm btn-warning">Editar</a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9">No hay productos en el inventario.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endblock %}