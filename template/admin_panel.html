{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel de Administraci√≥n</title>
    <link rel="icon" type="image/jpeg" href="{% static 'assets/img/LOGO.jpg' %}">
    <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
    <link href="{% static 'css/index.css' %}" rel="stylesheet" />
    <!-- Script para el cierre de sesi√≥n seguro -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Funci√≥n para obtener el valor de la cookie CSRF
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault(); // Evita que el enlace navegue
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = "{% url 'logout' %}";
                    form.innerHTML = `<input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">`;
                    document.body.appendChild(form);
                    form.submit();
                });
            }
        });
    </script>
</head>
<body class="sb-nav-fixed">
    <nav class="sb-topnav navbar navbar-expand navbar-light bg-light">
        <a class="navbar-brand ps-3" href="{% url 'dashboard' %}">Gesti√≥n de Bienes</a>
        <button class="btn btn-link btn-sm" id="sidebarToggle">‚ò∞</button>
    </nav>

    <div id="layoutSidenav">
        <div id="layoutSidenav_nav">
            {% include '_sidebar.html' %}
        </div>

        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <h2 class="mt-4">‚öôÔ∏è Panel de Administraci√≥n</h2>

                    <!-- Usuarios -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h4><i class="fas fa-users me-1"></i> üë• Gesti√≥n de Usuarios</h4>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <a href="{% url 'crear_usuario' %}" class="btn btn-primary">‚ûï Crear usuario</a>
                                <form method="get" class="d-flex" style="max-width: 300px;">
                                    <input class="form-control me-2" type="search" name="q" placeholder="Buscar usuario..." value="{{ current_query|default:'' }}">
                                    <button class="btn btn-outline-secondary" type="submit">Buscar</button>
                                </form>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Nombre</th>
                                            <th>Apellido</th>
                                            <th>Email</th>
                                            <th>Estado</th>
                                            <th>Admin</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for u in usuarios %}
                                        <tr>
                                            <td>{{ u.username }}</td>
                                            <td>{{ u.first_name }}</td>
                                            <td>{{ u.last_name }}</td>
                                            <td>{{ u.email }}</td>
                                            <td>
                                                {% if u.is_active %}
                                                    <span class="badge bg-success">Activo</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactivo</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if u.is_staff %}
                                                    <span class="badge bg-info">S√≠</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">No</span>
                                                {% endif %}
                                            </td>
                                            <td class="d-flex gap-1">
                                                {% if request.user.is_superuser %}
                                                <a href="{% url 'editar_usuario' u.id %}" class="btn btn-sm btn-warning" title="Editar">‚úèÔ∏è</a>
                                                <a href="{% url 'borrar_usuario' u.id %}" class="btn btn-sm btn-danger" title="Borrar">üóëÔ∏è</a>
                                                <form method="post" action="{% url 'toggle_user_active' u.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    {% if u.is_active %}
                                                        <button type="submit" class="btn btn-sm btn-outline-secondary" title="Desactivar">‚ùå</button>
                                                    {% else %}
                                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Activar">‚úîÔ∏è</button>
                                                    {% endif %}
                                                </form>
                                                {% if u != user %}
                                                <form method="post" action="{% url 'toggle_user_staff' u.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    {% if u.is_staff %}
                                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Quitar Admin">üõ°Ô∏è-</button>
                                                    {% else %}
                                                        <button type="submit" class="btn btn-sm btn-outline-info" title="Hacer Admin">üõ°Ô∏è+</button>
                                                    {% endif %}
                                                </form>
                                                {% endif %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="{% static 'js/scripts.js' %}"></script>
    <script src="{% static 'js/indexjs.js' %}"></script>
    <script src="{% static 'js/inactivity-timer.js' %}"></script>
</body>
</html>
